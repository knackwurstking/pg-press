<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8" />

        <!-- Viewport and responsive design -->
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
        />

        <!-- PWA and mobile optimization -->
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="PG-VIS" />
        <meta name="application-name" content="PG-VIS" />
        <meta name="msapplication-TileColor" content="#3e3c49" />
        <meta name="theme-color" content="#000000" />

        <!-- Icons and manifest -->
        <link rel="icon" href="./favicon.ico" sizes="any" />
        <link rel="icon" href="./icon.png" type="image/png" />
        <link rel="apple-touch-icon" href="./apple-touch-icon-180x180.png" />
        <link rel="mask-icon" href="./icon.png" color="#3e3c49" />

        <!-- PWA Manifest -->
        <link rel="manifest" href="./manifest.json" />

        <!-- Stylesheets -->
        <link rel="stylesheet" href="./css/bootstrap-icons.min.css" />
        <link rel="stylesheet" href="./css/ui.min.css" />
        <link rel="stylesheet" href="./css/layout.css" />

        <!-- Preconnect for performance -->
        <link rel="dns-prefetch" href="//fonts.googleapis.com" />

        <title>{{block "title" .}}PG-VIS{{end}}</title>

        <!-- HTMX for dynamic content -->
        <script src="./js/htmx-v2.0.6.min.js"></script>
        <script src="./js/htmx-ext-ws-v2.0.3.min.js"></script>

        <!-- WebSocket Manager for suspension handling -->
        <script src="./js/websocket-manager.js"></script>

        <!-- Service Worker Registration -->
        <script src="./js/sw-register.js"></script>

        <!-- PWA Manager -->
        <script src="./js/pwa-manager.js"></script>

        {{block "head" .}}{{end}}
    </head>

    <body hx-ext="ws">
        <header class="container fluid">
            <nav class="flex row gap justify-between">
                <div class="flex row gap justify-start align-center">
                    <div>
                        <h5>{{block "app-bar-title" .}}PG-VIS{{end}}</h5>
                    </div>
                </div>

                {{block "nav" .}}{{end}}
            </nav>
        </header>

        <main>{{block "content" .}}{{end}}</main>

        <!-- Additional PWA features -->

        <script>
            // Handle form submissions with offline support
            document.addEventListener("submit", (event) => {
                const form = event.target;

                // Add loading state
                const submitBtn = form.querySelector(
                    'button[type="submit"], input[type="submit"]',
                );
                if (submitBtn) {
                    submitBtn.classList.add("loading");
                }

                // If offline, queue the submission
                if (!navigator.onLine && "serviceWorker" in navigator) {
                    // This would integrate with the background sync feature
                    console.log(
                        "[PWA] Form submitted while offline - queuing for sync",
                    );
                }
            });

            // Add visual feedback for cached content
            document.addEventListener("htmx:afterSwap", (event) => {
                // Check if content was served from cache
                const response = event.detail.xhr;
                if (
                    response &&
                    response.getResponseHeader("X-Cache-Status") === "HIT"
                ) {
                    console.log("[PWA] Content loaded from cache");
                }
            });

            // Performance monitoring for PWA
            if ("performance" in window) {
                window.addEventListener("load", () => {
                    setTimeout(() => {
                        const perfData =
                            performance.getEntriesByType("navigation")[0];
                        console.log("[PWA] Performance metrics:", {
                            loadTime:
                                perfData.loadEventEnd - perfData.loadEventStart,
                            domContentLoaded:
                                perfData.domContentLoadedEventEnd -
                                perfData.domContentLoadedEventStart,
                            firstPaint:
                                performance.getEntriesByName("first-paint")[0]
                                    ?.startTime || "N/A",
                        });
                    }, 0);
                });
            }
        </script>
    </body>
</html>

{{define "basic-nav-elements"}}
<div class="flex row gap justify-end align-center">
    {{template "nav-feed"}}

    <a
        role="button"
        class="ghost contrast icon"
        href="./profile"
        title="Profil"
    >
        <i class="bi bi-person-circle"></i>
    </a>

    <a role="button" class="ghost contrast icon" href="./" title="Startseite">
        <i class="bi bi-house"></i>
    </a>
</div>
{{end}}
