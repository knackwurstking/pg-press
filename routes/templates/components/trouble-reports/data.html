{{$pageData := .}} {{if ne (len $pageData.TroubleReports) 0}}
<ul id="data">
    <style>
        pre {
            text-wrap: wrap;
        }
    </style>

    {{range $troubleReport := $pageData.TroubleReports}}
    {{$id := print "trouble-report-" $troubleReport.ID}}
    <span class="trouble-report">
        <details
            id="{{$id}}"
            style="margin: var(--ui-spacing) auto"
        >
            <summary>{{$troubleReport.Title}}</summary>
            <pre>{{$troubleReport.Content}}</pre>

            <!-- Attachments Preview Container -->
            {{if and $troubleReport.LoadedAttachments (gt (len $troubleReport.LoadedAttachments) 0)}}
            <div class="attachments-preview-container">
                <div class="attachments-preview-label">
                    <i class="bi bi-paperclip"></i>
                    Anhänge ({{len $troubleReport.LoadedAttachments}})
                </div>
                <div class="attachments-preview-scroll">
                    {{range $troubleReport.LoadedAttachments}}
                    <div class="attachment-preview-item" onclick="viewAttachmentFromData({{$troubleReport.ID}}, {{.GetID}}, '{{if .IsImage}}true{{else}}false{{end}}')">
                        {{if .IsImage}}
                        <div class="attachment-preview-image">
                            <img
                                src="./trouble-reports/attachments?id={{$troubleReport.ID}}&attachment_id={{.GetID}}"
                                alt="Attachment {{.ID}}"
                                class="preview-thumbnail"
                            />
                        </div>
                        {{else}}
                        <div class="attachment-preview-icon">
                            {{if .IsDocument}}
                            <i class="bi bi-file-text"></i>
                            {{else if .IsArchive}}
                            <i class="bi bi-file-zip"></i>
                            {{else}}
                            <i class="bi bi-file-earmark"></i>
                            {{end}}
                        </div>
                        {{end}}
                        <div class="attachment-preview-name">
                            Attachment {{.ID}}
                        </div>
                        <div class="attachment-preview-type">
                            {{.GetMimeType}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}

        </details>

        <div class="actions flex row gap justify-end align-center">
            <button
                hx-get="./trouble-reports/modifications/{{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                class="ghost secondary icon"
            >
                <i class="bi bi-clock-history"></i>
            </button>

            <button
                hx-get="./trouble-reports/dialog-edit?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#dialogEdit"
                hx-swap="outerHTML"
                class="ghost icon"
                style="color: green;"
            >
                <i class="bi bi-pen"></i>
            </button>

            {{if $pageData.User.IsAdmin}}
            <button
                hx-delete="./trouble-reports/data?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                hx-confirm="Sind Sie sicher, dass Sie diesen Fehlerbericht löschen möchten?"
                class="ghost destructive icon"
            >
                <i class="bi bi-trash"></i>
            </button>

            {{else}}
            <!-- TODO: Benutzer ist kein Administrator, Abstimmungssystem zum Löschen von Problemberichten hinzufügen, noch nicht implementiert -->

            <button
                id="voteForDelete"
                hx-post="./trouble-reports/vote?id={{$troubleReport.ID}}&mode=delete"
                hx-trigger="click"
                hx-swap="outerHTML"
                class="ghost destructive flex column justify-between align-center"
                style="transform: scale(0.75);"
                disabled
            >
                <i class="bi bi-trash"></i>
                <small>ABSTIMMEN</small>
            </button>
            {{end}}
        </div>
        <hr />
    </span>
    {{end}}

    <script>
        (() => {
            if (!location.hash) return

            const el = document.querySelector(location.hash);
            if (!el) return;

            el.open = true;
        })();
    </script>
</ul>
{{else}}
<span id="data"></span>
{{end}}
