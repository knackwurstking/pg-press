{{$pageData := .}} {{if ne (len $pageData.TroubleReports) 0}}
<ul id="data">
    <style>
        pre {
            text-wrap: wrap;
        }
    </style>

    {{range $troubleReport := $pageData.TroubleReports}}
    {{$id := print "trouble-report-" $troubleReport.ID}}
    <span class="trouble-report">
        <details
            id="{{$id}}"
            style="margin: var(--ui-spacing) auto"
        >
            <summary>{{$troubleReport.Title}}</summary>
            <pre>{{$troubleReport.Content}}</pre>

            <!-- Attachments Preview Container -->
            {{if and $troubleReport.LoadedAttachments (gt (len $troubleReport.LoadedAttachments) 0)}}
            <div
                class="attachments-preview-placeholder"
                data-trouble-report-id="{{$troubleReport.ID}}"
                hx-get="./trouble-reports/attachments-preview?id={{$troubleReport.ID}}"
                hx-trigger="load-attachments-{{$troubleReport.ID}} from:body"
                hx-swap="outerHTML"
            >
                <div class="attachments-preview-label">
                    <i class="bi bi-paperclip"></i>
                    AnhÃ¤nge ({{len $troubleReport.LoadedAttachments}}) - Klicken Sie hier, um zu laden...
                </div>
            </div>
            {{end}}

        </details>

        <div class="actions flex row gap justify-end align-center">
            <button
                hx-get="./trouble-reports/modifications/{{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                class="ghost secondary icon"
            >
                <i class="bi bi-clock-history"></i>
            </button>

            <button
                hx-get="./trouble-reports/dialog-edit?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#dialogEdit"
                hx-swap="outerHTML"
                class="ghost icon"
                style="color: green;"
            >
                <i class="bi bi-pen"></i>
            </button>

            <button
                id="share-btn-{{$troubleReport.ID}}"
                onclick="shareTroubleReportPDF({{$troubleReport.ID}}, '{{$troubleReport.Title}}')"
                class="ghost icon"
                style="color: blue;"
                title="Als PDF teilen"
            >
                <i class="bi bi-share"></i>
            </button>



            {{if $pageData.User.IsAdmin}}
            <button
                hx-delete="./trouble-reports/data?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                hx-confirm="Sind Sie sicher, dass Sie diesen Fehlerbericht lÃ¶schen mÃ¶chten?"
                class="ghost destructive icon"
            >
                <i class="bi bi-trash"></i>
            </button>

            {{else}}
            <!-- TODO: Benutzer ist kein Administrator, Abstimmungssystem zum LÃ¶schen von Problemberichten hinzufÃ¼gen, noch nicht implementiert -->

            <button
                id="voteForDelete"
                hx-post="./trouble-reports/vote?id={{$troubleReport.ID}}&mode=delete"
                hx-trigger="click"
                hx-swap="outerHTML"
                class="ghost destructive flex column justify-between align-center"
                style="transform: scale(0.75);"
                disabled
            >
                <i class="bi bi-trash"></i>
                <small>ABSTIMMEN</small>
            </button>
            {{end}}
        </div>
        <hr />
    </span>
    {{end}}

    <script defer>
        (() => {


            // Update share button appearance based on HTTPS/HTTP
            const isHTTPS = location.protocol === 'https:';
            const canUseWebShare = isHTTPS;
            
            document.querySelectorAll('[id^="share-btn-"]').forEach(button => {
                if (!canUseWebShare) {
                    // HTTP connection - change to download appearance
                    button.style.color = '#6c757d';
                    button.style.border = '1px dashed #6c757d';
                    button.title = 'PDF herunterladen (HTTPS erforderlich fÃ¼r Teilen)';
                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.className = 'bi bi-download';
                    }
                } else {
                    // HTTPS connection - keep share appearance
                    button.title = 'Als PDF teilen';
                }
            });

            // Function to handle attachment loading
            function loadAttachmentsForTroubleReport(troubleReportId) {
                const placeholder = document.querySelector(`[data-trouble-report-id="${troubleReportId}"]`);
                if (placeholder) {
                    htmx.trigger(document.body, `load-attachments-${troubleReportId}`);
                }
            }

            // Handle hash-based navigation after HTMX has loaded
            function handleHashNavigation() {
                if (location.hash) {
                    const el = document.querySelector(location.hash);
                    if (el) {
                        el.open = true;
                        const troubleReportId = el.id.replace('trouble-report-', '');
                        loadAttachmentsForTroubleReport(troubleReportId);
                    }
                }
            }

            // Run hash navigation after HTMX has finished processing
            document.addEventListener('htmx:load', handleHashNavigation);

            // Also run immediately in case HTMX has already loaded
            handleHashNavigation();

            // Add event listeners for details toggle
            document.querySelectorAll('details[id^="trouble-report-"]').forEach(details => {
                details.addEventListener('toggle', function() {
                    if (this.open) {
                        const troubleReportId = this.id.replace('trouble-report-', '');
                        loadAttachmentsForTroubleReport(troubleReportId);
                    }
                });
            });

            // Function to share trouble report PDF
            window.shareTroubleReportPDF = async function(troubleReportId, title) {
                let button = null;
                let originalContent = '';

                try {
                    // Show loading state
                    button = event.target.closest('button');
                    if (!button) {
                        alert('Fehler: Share-Button nicht gefunden.');
                        return;
                    }

                    originalContent = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    button.disabled = true;

                    // Check HTTPS requirement for Web Share API
                    const isHTTPS = location.protocol === 'https:';
                    const canUseWebShare = isHTTPS;
                    
                    console.log('=== PDF Share Decision Path ===');
                    console.log('Current URL:', location.href);
                    console.log('Protocol:', location.protocol);
                    console.log('Hostname:', location.hostname);
                    console.log('HTTPS:', isHTTPS);
                    console.log('Can use Web Share API:', canUseWebShare);
                    console.log('navigator.share exists:', 'share' in navigator);
                    console.log('navigator.canShare exists:', 'canShare' in navigator);
                    
                    if (!canUseWebShare) {
                        console.log('ðŸš« Decision: FORCE DIRECT DOWNLOAD - HTTPS required for Web Share API, skipping entirely');
                    } else {
                        console.log('âœ… Decision: HTTPS detected - will attempt Web Share API');
                    }

                    // Fetch PDF from server
                    const response = await fetch(`./trouble-reports/share-pdf?id=${troubleReportId}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const blob = await response.blob();
                    const filename = `fehlerbericht_${troubleReportId}_${new Date().toISOString().split('T')[0]}.pdf`;

                    // Decision: Use Web Share API only if HTTPS/localhost AND browser supports it
                    if (canUseWebShare) {
                        console.log('ðŸ”’ Secure context confirmed - checking Web Share API support...');
                        
                        if (navigator.share && navigator.canShare) {
                            const file = new File([blob], filename, { type: 'application/pdf' });
                            const shareData = {
                                title: `Fehlerbericht: ${title}`,
                                text: `Fehlerbericht #${troubleReportId}`,
                                files: [file]
                            };

                            // Check if we can share files and attempt to share
                            if (navigator.canShare(shareData)) {
                                console.log('Attempting Web Share API with file...');
                                try {
                                    await navigator.share(shareData);
                                    // Show success feedback
                                    button.innerHTML = '<i class="bi bi-check-circle"></i>';
                                    button.style.color = 'green';
                                    setTimeout(() => {
                                        button.innerHTML = originalContent;
                                        button.style.color = 'blue';
                                        button.disabled = false;
                                    }, 1500);
                                    return; // Success - exit function
                                } catch (shareError) {
                                    console.log('Web Share API failed:', shareError);
                                    
                                    // Handle specific error types
                                    if (shareError.name === 'NotAllowedError') {
                                        console.log('Share permission denied');
                                    } else if (shareError.name === 'AbortError') {
                                        console.log('Share cancelled by user');
                                    } else {
                                        console.log('Other share error:', shareError.name);
                                    }
                                    
                                    // Fall through to download
                                }
                            } else {
                                console.log('Cannot share files - falling back to download');
                            }
                        } else {
                            console.log('Web Share API not available - falling back to download');
                        }
                    } else {
                        console.log('ðŸš« Non-HTTPS connection - FORCING direct download, NO Web Share API attempt');
                        console.log('This prevents empty shares with missing PDF files');
                    }

                    // Download the PDF (fallback or direct)
                    console.log('ðŸ“¥ Starting PDF download...');
                    console.log('Reason:', canUseWebShare ? 'Web Share API failed/unsupported' : 'Non-HTTPS connection - direct download');
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Show download success feedback
                    button.innerHTML = '<i class="bi bi-download"></i>';
                    button.style.color = 'green';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.style.color = 'blue';
                        button.disabled = false;
                    }, 1500);

                } catch (error) {
                    console.error('Error sharing/downloading PDF:', error);
                    alert('Fehler beim Erstellen oder Teilen der PDF. Bitte versuchen Sie es erneut.');
                    // Restore button state on error
                    if (button && originalContent) {
                        button.innerHTML = originalContent;
                        button.style.color = 'blue';
                        button.disabled = false;
                    }
                }
            };


        })();
    </script>
</ul>
{{else}}
<span id="data"></span>
{{end}}
