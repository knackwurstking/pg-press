{{$pageData := .}} {{if ne (len $pageData.TroubleReports) 0}}
<ul id="data">
    <style>
        pre {
            text-wrap: wrap;
        }
    </style>

    {{range $troubleReport := $pageData.TroubleReports}}
    {{$id := print "trouble-report-" $troubleReport.ID}}
    <span class="trouble-report">
        <details
            id="{{$id}}"
            style="margin: var(--ui-spacing) auto"
        >
            <summary>{{$troubleReport.Title}}</summary>
            <pre>{{$troubleReport.Content}}</pre>

            <!-- Attachments Preview Container -->
            {{if and $troubleReport.LoadedAttachments (gt (len $troubleReport.LoadedAttachments) 0)}}
            <div
                class="attachments-preview-placeholder"
                data-trouble-report-id="{{$troubleReport.ID}}"
                hx-get="./trouble-reports/attachments-preview?id={{$troubleReport.ID}}"
                hx-trigger="load-attachments-{{$troubleReport.ID}} from:body"
                hx-swap="outerHTML"
                onclick="loadAttachmentsForTroubleReport('{{$troubleReport.ID}}')"
                style="cursor: pointer;"
            >
                <div class="attachments-preview-label">
                    <i class="bi bi-paperclip"></i>
                    Anh√§nge ({{len $troubleReport.LoadedAttachments}}) - Klicken Sie hier, um zu laden...
                </div>
            </div>
            {{end}}

        </details>

        <div class="actions flex row gap justify-end align-center">
            <button
                hx-get="./trouble-reports/modifications/{{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                class="ghost secondary icon"
            >
                <i class="bi bi-clock-history"></i>
            </button>

            <button
                hx-get="./trouble-reports/dialog-edit?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#dialogEdit"
                hx-swap="outerHTML"
                class="ghost icon"
            >
                <i class="bi bi-pen"></i>
            </button>

            <button
                id="share-btn-{{$troubleReport.ID}}"
                onclick="shareTroubleReportPDF({{$troubleReport.ID}}, '{{$troubleReport.Title}}')"
                class="ghost icon info"
                title="Als PDF teilen"
            >
                <i class="bi bi-share"></i>
            </button>



            {{if $pageData.User.IsAdmin}}
            <button
                hx-delete="./trouble-reports/data?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                hx-confirm="Sind Sie sicher, dass Sie diesen Fehlerbericht l√∂schen m√∂chten?"
                class="ghost destructive icon"
            >
                <i class="bi bi-trash"></i>
            </button>

            {{else}}
            <!-- TODO: Benutzer ist kein Administrator, Abstimmungssystem zum L√∂schen von Problemberichten hinzuf√ºgen, noch nicht implementiert -->

            <button
                id="voteForDelete"
                hx-post="./trouble-reports/vote?id={{$troubleReport.ID}}&mode=delete"
                hx-trigger="click"
                hx-swap="outerHTML"
                class="ghost destructive flex column justify-between align-center"
                style="transform: scale(0.75);"
                disabled
            >
                <i class="bi bi-trash"></i>
                <small>ABSTIMMEN</small>
            </button>
            {{end}}
        </div>
        <hr />
    </span>
    {{end}}

    <script defer>
        (() => {


            // Update share button appearance based on HTTPS/HTTP
            const isHTTPS = location.protocol === 'https:';
            const canUseWebShare = isHTTPS;

            document.querySelectorAll('[id^="share-btn-"]').forEach(button => {
                if (!canUseWebShare) {
                    // HTTP connection - change to download appearance
                    button.title = 'PDF herunterladen (HTTPS erforderlich f√ºr Teilen)';
                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.className = 'bi bi-download';
                    }
                } else {
                    // HTTPS connection - keep share appearance
                    button.title = 'Als PDF teilen';
                }
            });

            // Function to handle attachment loading
            function loadAttachmentsForTroubleReport(troubleReportId) {
                console.log('üîç Loading attachments for trouble report ID:', troubleReportId);
                const placeholder = document.querySelector(`[data-trouble-report-id="${troubleReportId}"]`);
                console.log('üéØ Found placeholder element:', placeholder);
                if (placeholder) {
                    console.log('üöÄ Triggering HTMX load for:', `load-attachments-${troubleReportId}`);
                    htmx.trigger(document.body, `load-attachments-${troubleReportId}`);
                } else {
                    console.warn('‚ùå No placeholder found for trouble report ID:', troubleReportId);
                }
            }

            // Handle hash-based navigation after HTMX has loaded
            function handleHashNavigation() {
                console.log('üîó Hash navigation check, current hash:', location.hash);
                if (location.hash) {
                    const el = document.querySelector(location.hash);
                    console.log('üéØ Found hash element:', el);
                    if (el) {
                        el.open = true;
                        const troubleReportId = el.id.replace('trouble-report-', '');
                        console.log('üÜî Extracted trouble report ID from hash:', troubleReportId);
                        loadAttachmentsForTroubleReport(troubleReportId);
                    }
                } else {
                    console.log('‚ÑπÔ∏è No hash in URL');
                }
            }

            // Run hash navigation after HTMX has finished processing
            document.addEventListener('htmx:load', handleHashNavigation);

            // Also run immediately in case HTMX has already loaded
            handleHashNavigation();

            // Add event listeners for details toggle
            document.querySelectorAll('details[id^="trouble-report-"]').forEach(details => {
                console.log('üìã Setting up toggle listener for:', details.id);
                details.addEventListener('toggle', function() {
                    console.log('üîÑ Details toggle event for:', this.id, 'open:', this.open);
                    if (this.open) {
                        const troubleReportId = this.id.replace('trouble-report-', '');
                        console.log('‚úÖ Details opened, loading attachments for ID:', troubleReportId);
                        loadAttachmentsForTroubleReport(troubleReportId);
                    }
                });
            });

            // PDF sharing functionality is now in main.js

            // Add HTMX event listeners for debugging attachment loading
            document.addEventListener('htmx:beforeRequest', function(event) {
                if (event.detail.requestConfig.path.includes('attachments-preview')) {
                    console.log('üîÑ HTMX: Before attachment request', {
                        path: event.detail.requestConfig.path,
                        trigger: event.detail.requestConfig.triggeringEvent,
                        target: event.target
                    });
                }
            });

            document.addEventListener('htmx:afterRequest', function(event) {
                if (event.detail.requestConfig.path.includes('attachments-preview')) {
                    console.log('‚úÖ HTMX: After attachment request', {
                        path: event.detail.requestConfig.path,
                        status: event.detail.xhr.status,
                        response: event.detail.xhr.responseText.substring(0, 200),
                        target: event.target
                    });
                }
            });

            document.addEventListener('htmx:responseError', function(event) {
                if (event.detail.requestConfig.path.includes('attachments-preview')) {
                    console.error('‚ùå HTMX: Attachment request error', {
                        path: event.detail.requestConfig.path,
                        status: event.detail.xhr.status,
                        error: event.detail.xhr.responseText,
                        target: event.target
                    });
                }
            });

            document.addEventListener('htmx:swapError', function(event) {
                if (event.detail.requestConfig.path.includes('attachments-preview')) {
                    console.error('üîÑ HTMX: Attachment swap error', {
                        path: event.detail.requestConfig.path,
                        error: event.detail.error,
                        target: event.target
                    });
                }
            });

        })();
    </script>
</ul>
{{else}}
<span id="data"></span>
{{end}}
