{{if not .Submitted}}
<dialog id="dialogEdit" class="clean fullscreen" oncancel="event.preventDefault()">
    <style>
        form {
            width: 100%;
            height: 100%;
        }

        .content {
            height: 100%;
            margin: 0;
        }

        label[for="title"] {
            max-height: fit-content;
        }

        input[name="title"] {
            width: 100%;
        }

        label[for="content"] {
            height: 100%;
        }

        textarea[name="content"] {
            width: 100%;
            height: 100%;
            resize: none;
        }

        /* Attachment Styles */
        .attachments-section {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 4px 0;
            border: var(--ui-border-width) var(--ui-border-style) var(--ui-border-color);
            border-radius: 4px;
            cursor: move;
        }

        .attachment-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }

        .attachment-actions {
            display: flex;
            gap: 4px;
        }

        .attachment-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .file-input-area {
            border: 2px dashed var(--ui-border-color);
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-top: 8px;
        }

        .file-input-area:hover {
            border-color: var(--ui-info);
        }

        .file-input-area.dragover {
            border-color: var(--ui-info);
        }

        #attachments {
            display: none;
        }

        .attachment-error {
            color: var(--ui-destructive);
            font-size: 12px;
            margin-top: 4px;
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        .attachments-label {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .file-preview {
            display: none;
            margin-top: 8px;
        }

        .text-muted {
            color: var(--ui-muted-text, #666);
            font-size: 12px;
        }

        .small {
            font-size: 11px;
            padding: 2px 6px;
        }
    </style>

    <form
        {{if gt .ID 0}}
        hx-put="./trouble-reports/dialog-edit?id={{.ID}}"
        {{else}}
        hx-post="./trouble-reports/dialog-edit"
        {{end}}
        hx-trigger="submit"
        hx-target="#dialogEdit"
        hx-swap="outerHTML"
        enctype="multipart/form-data"
        class="flex column gap">

        <!-- Hidden field for attachment order -->
        <input type="hidden" name="attachment_order" id="attachment-order" value="">

        <div
            style="padding: var(--ui-spacing);"
            class="content flex-item flex column gap auto-scroll-y"
        >
            <label for="title" class="flex column">
                Titel
                <input
                    name="title"
                    id="title"
                    placeholder="Titel"
                    value="{{.Title}}"
                    {{if .InvalidTitle}}
                    aria-invalid="true"
                    {{end}} />
            </label>

            <label for="content" class="flex column">
                Bericht
                <textarea
                    name="content"
                    id="content"
                    placeholder="Bericht"
                    {{if .InvalidContent}}
                    aria-invalid="true"
                    {{end}}
                >{{.Content}}</textarea>
            </label>

            <!-- Attachments Section -->
            <div id="attachments-section" class="attachments-container flex-item">
                <div class="attachments-label">Anhänge (max. 10MB pro Datei, max. 10 Dateien)</div>

                {{if .AttachmentError}}
                <div class="attachment-error">{{.AttachmentError}}</div>
                {{end}}

                <!-- Existing Attachments -->
                {{if .LinkedAttachments}}
                <div class="attachments-section">
                    <div class="attachments-label">Vorhandene Anhänge:</div>
                    <div id="existing-attachments">
                        {{range .LinkedAttachments}}
                        <div class="attachment-item flex row gap" data-id="{{.ID}}">
                            <div class="attachment-info">
                                <i class="bi bi-grip-vertical"></i>
                                {{if .IsImage}}
                                <i class="bi bi-image attachment-icon"></i>
                                {{else if .IsDocument}}
                                <i class="bi bi-file-text attachment-icon"></i>
                                {{else if .IsArchive}}
                                <i class="bi bi-file-zip attachment-icon"></i>
                                {{else}}
                                <i class="bi bi-file-earmark attachment-icon"></i>
                                {{end}}
                                <span class="ellipsis">{{.ID}}</span>
                                <span class="text-muted">({{.GetMimeType}})</span>
                            </div>
                            <div class="attachment-actions">
                                <button type="button" class="secondary small" onclick="viewAttachment({{$.ID}}, '{{.ID}}')">
                                    <i class="bi bi-eye"></i> Anzeigen
                                </button>
                                <button type="button" class="destructive small" onclick="deleteAttachment({{$.ID}}, '{{.ID}}')">
                                    <i class="bi bi-trash"></i> Löschen
                                </button>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}

                <!-- File Upload Area -->
                <div class="file-input-area"
                     onclick="document.getElementById('attachments').click()"
                     ondrop="handleFileDrop(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)">
                    <i class="bi bi-cloud-upload" style="font-size: 2em; margin-bottom: 8px;"></i>
                    <div>Klicken Sie hier oder ziehen Sie Dateien hierher</div>
                    <div class="text-muted">Unterstützte Formate: Bilder, PDFs, Dokumente, Archive</div>
                    <input type="file"
                           name="attachments"
                           id="attachments"
                           multiple
                           accept="image/*,.pdf,.doc,.docx,.txt,.rtf,.odt,.zip,.rar,.7z,.tar,.gz,.bz2"
                           onchange="handleFileSelect(event)">
                </div>

                <!-- File Preview Area -->
                <div id="file-preview" class="file-preview">
                    <div class="attachments-label">Neue Dateien:</div>
                    <div id="new-attachments"></div>
                </div>
            </div>
        </div>

        <footer class="flex row gap justify-end">
            <button
                hx-get="./trouble-reports/dialog-edit?cancel=true"
                hx-trigger="click"
                hx-target="#dialogEdit"
                hx-swap="outerHTML"
                type="button"
                class="secondary flex row gap"
            >
                <i class="bi bi-x-circle"></i>
                Schließen
            </button>

            <!-- Set button text based on ID value -->
            <button type="submit" class="flex row gap">
                <i class="bi bi-check-circle"></i>
                {{if gt .ID 0}} Aktualisieren {{else}} Erstellen {{end}}
            </button>
        </footer>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.querySelector("#dialogEdit").showModal();

        // Initialize variables and functions
        (function() {
            // Local variables to avoid global conflicts
            let attachmentOrder = [];
            let selectedFiles = [];

            // Reset file state to prevent duplicates on dialog reopen
            function resetFileState() {
                selectedFiles = [];
                const fileInput = document.getElementById('attachments');
                if (fileInput) {
                    fileInput.value = '';
                }
                const previewArea = document.getElementById('file-preview');
                if (previewArea) {
                    previewArea.style.display = 'none';
                }
                const container = document.getElementById('new-attachments');
                if (container) {
                    container.innerHTML = '';
                }
            }

            // Update hidden input with current attachment order
            function updateAttachmentOrderInput() {
                document.getElementById('attachment-order').value = attachmentOrder.join(',');
            }

            // Initialize attachment order from existing attachments
            function initializeAttachmentOrder() {
                // Initialize sortable for existing attachments
                if (window.Sortable && document.getElementById('existing-attachments')) {
                    new Sortable(document.getElementById('existing-attachments'), {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        handle: '.bi-grip-vertical',
                        onEnd: function(evt) {
                            // Update attachment order
                            const items = document.querySelectorAll('#existing-attachments .attachment-item');
                            attachmentOrder = Array.from(items).map(item => item.dataset.id);
                            updateAttachmentOrderInput();
                        }
                    });
                }

                const existingAttachments = document.querySelectorAll('#existing-attachments .attachment-item');
                attachmentOrder = Array.from(existingAttachments).map(item => item.dataset.id);
                updateAttachmentOrderInput();
            }

            // Update the file input with current selected files
            function updateFileInput() {
                const fileInput = document.getElementById('attachments');
                const dt = new DataTransfer();

                selectedFiles.forEach(file => {
                    dt.items.add(file);
                });

                fileInput.files = dt.files;
            }

            // Display file preview
            function displayFilePreview() {
                const previewArea = document.getElementById('file-preview');
                const container = document.getElementById('new-attachments');
                container.innerHTML = '';

                if (selectedFiles.length > 0) {
                    previewArea.style.display = 'block';

                    selectedFiles.forEach((file, index) => {
                        const sizeClass = file.size > 10 * 1024 * 1024 ? 'attachment-error' : 'text-muted';
                        const sizeText = file.size > 10 * 1024 * 1024 ? 'ZU GROSS!' : formatFileSize(file.size);

                        const item = document.createElement('div');
                        item.className = 'attachment-item flex row gap';
                        item.innerHTML = `
                            <div class="attachment-info">
                                <i class="bi bi-file-earmark attachment-icon"></i>
                                <span class="ellipsis">${file.name}</span>
                                <span class="${sizeClass}">(${sizeText})</span>
                            </div>
                            <div class="attachment-actions">
                                <button type="button" class="destructive small" onclick="window.dialogEditFunctions.removeFileFromPreview(${index})">
                                    <i class="bi bi-trash"></i> Entfernen
                                </button>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    previewArea.style.display = 'none';
                }
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Expose functions globally that need to be called from HTML
            window.dialogEditFunctions = {
                handleFileSelect: function(event) {
                    selectedFiles = Array.from(event.target.files);
                    displayFilePreview();
                },

                handleFileDrop: function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    const area = event.currentTarget;
                    area.classList.remove('dragover');

                    selectedFiles = Array.from(event.dataTransfer.files);
                    updateFileInput();
                    displayFilePreview();
                },

                handleDragOver: function(event) {
                    event.preventDefault();
                    event.currentTarget.classList.add('dragover');
                },

                handleDragLeave: function(event) {
                    event.currentTarget.classList.remove('dragover');
                },

                removeFileFromPreview: function(index) {
                    selectedFiles.splice(index, 1);
                    updateFileInput();
                    displayFilePreview();
                },

                viewAttachment: function(reportId, attachmentId) {
                    window.open(`./trouble-reports/attachments?id=${reportId}&attachment_id=${attachmentId}`, '_blank');
                },

                deleteAttachment: function(reportId, attachmentId) {
                    if (confirm('Sind Sie sicher, dass Sie diesen Anhang löschen möchten?')) {
                        htmx.ajax('DELETE', `./trouble-reports/attachments?id=${reportId}&attachment_id=${attachmentId}`, {
                            target: '#attachments-section',
                            swap: 'innerHTML'
                        });
                    }
                }
            };

            // Reset file state and initialize attachment order on load
            resetFileState();
            initializeAttachmentOrder();

            // Form validation
            document.querySelector('form').addEventListener('submit', function(e) {
                let hasOversizedFiles = false;

                selectedFiles.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        hasOversizedFiles = true;
                    }
                });

                if (hasOversizedFiles) {
                    e.preventDefault();
                    alert('Einige Dateien sind zu groß. Die maximale Dateigröße beträgt 10MB.');
                    return false;
                }

                const totalFiles = selectedFiles.length + (document.querySelectorAll('#existing-attachments .attachment-item').length || 0);
                if (totalFiles > 10) {
                    e.preventDefault();
                    alert('Zu viele Anhänge. Maximal 10 Anhänge sind erlaubt.');
                    return false;
                }
            });
        })();

        // Global functions for backward compatibility
        function handleFileSelect(event) { window.dialogEditFunctions.handleFileSelect(event); }
        function handleFileDrop(event) { window.dialogEditFunctions.handleFileDrop(event); }
        function handleDragOver(event) { window.dialogEditFunctions.handleDragOver(event); }
        function handleDragLeave(event) { window.dialogEditFunctions.handleDragLeave(event); }
        function viewAttachment(reportId, attachmentId) { window.dialogEditFunctions.viewAttachment(reportId, attachmentId); }
        function deleteAttachment(reportId, attachmentId) { window.dialogEditFunctions.deleteAttachment(reportId, attachmentId); }
    </script>
</dialog>
{{else}}
<span
    hx-get="./trouble-reports/data"
    hx-trigger="load"
    hx-target="#data"
    hx-swap="outerHTML"
    id="dialogEdit"></span>
{{end}}
