{{if not .Submitted}}
<dialog id="dialogEdit" class="clean fullscreen" oncancel="event.preventDefault()">
    <script>
        // Globals

        var attachmentOrder = [];
        var sortableInstance = null;

        // Helper Functions

        function updateAttachmentOrderInput() {
            document.getElementById("attachment-order").value =
                attachmentOrder.join(",");
        }

        function initializeAttachmentOrder() {
            const existingAttachmentsContainer = document.getElementById(
                "existing-attachments",
            );

            // Destroy existing Sortable instance if it exists
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }

            if (Sortable && existingAttachmentsContainer) {
                sortableInstance = new Sortable(existingAttachmentsContainer, {
                    animation: 150,
                    ghostClass: "sortable-ghost",
                    handle: ".bi-grip-vertical",
                    onEnd: function () {
                        const items = document.querySelectorAll(
                            "#existing-attachments .attachment-item",
                        );
                        attachmentOrder = Array.from(items).map(
                            (item) => item.dataset.id,
                        );
                        updateAttachmentOrderInput();
                    },
                });
            }

            const existingAttachments = document.querySelectorAll(
                "#existing-attachments .attachment-item",
            );
            attachmentOrder = Array.from(existingAttachments).map(
                (item) => item.dataset.id,
            );
            updateAttachmentOrderInput();
        }

        // Main Functions

        function deleteAttachment(attachmentId) {
            if (
                confirm(
                    "Sind Sie sicher, dass Sie diesen Anhang löschen möchten?",
                )
            ) {
                // FIXME: htmx: TypeError: null is not an object (evaluating 'e[t]')

                // Find and remove the attachment item from DOM
                const attachmentItem = document.querySelector(
                    `#existing-attachments .attachment-item[data-id="${attachmentId}"]`,
                );

                if (attachmentItem) {
                    // Remove from attachmentOrder array
                    attachmentOrder = attachmentOrder.filter(
                        (id) => id != attachmentId,
                    );

                    // Temporarily disable htmx processing during DOM manipulation
                    const container = document.getElementById(
                        "existing-attachments",
                    );
                    const wasDisabled =
                        container.hasAttribute("data-hx-disable");
                    container.setAttribute("data-hx-disable", "true");

                    // Remove the DOM element
                    attachmentItem.remove();

                    // Restore htmx state
                    if (!wasDisabled) {
                        container.removeAttribute("data-hx-disable");
                    }

                    // Update the hidden input field
                    updateAttachmentOrderInput();

                    // Reinitialize Sortable instance after DOM changes
                    initializeAttachmentOrder();

                    // Check if no attachments left and hide the details section
                    const existingAttachments = document.getElementById(
                        "existing-attachments",
                    );
                    if (
                        existingAttachments &&
                        existingAttachments.children.length === 0
                    ) {
                        const detailsSection =
                            existingAttachments.closest("details");
                        if (detailsSection) {
                            detailsSection.style.display = "none";
                        }
                    }
                }
            }
        }

        // TODO: Show attachment handler
    </script>

    <form
        class="flex column gap"

        {{if gt .ID 0}}
        hx-put="./trouble-reports/dialog-edit?id={{.ID}}"
        {{else}}
        hx-post="./trouble-reports/dialog-edit"
        {{end}}

        hx-trigger="submit"
        hx-target="#dialogEdit"
        hx-swap="outerHTML"

        enctype="multipart/form-data"
    >
        <!-- Hidden field for attachment order -->
        <input type="hidden" name="attachment_order" id="attachment-order" value=""/>

        <div class="form-content flex-item flex column gap auto-scroll-y">
            <label for="title" class="flex column">
                Titel

                <input
                    name="title"
                    id="title"

                    placeholder="Titel"
                    value="{{.Title}}"

                    {{if .InvalidTitle}}
                    aria-invalid="true"
                    {{end}}
                />
            </label>

            <label for="content" class="flex column">
                Bericht

                <textarea
                    name="content"
                    id="content"

                    placeholder="Bericht"

                    {{if .InvalidContent}}
                    aria-invalid="true"
                    {{end}}
                >{{.Content}}</textarea>
            </label>

            <!-- Attachments Section -->
            <div id="attachments-section" class="attachments-container flex-item flex column gap">
                <div class="attachments-label">
                    Bilder (max. 10MB pro Datei, max. 10 Dateien)
                </div>

                {{if or .InvalidTitle .InvalidContent}}
                <div class="attachment-error">
                    <i class="bi bi-exclamation-triangle"></i>
                    Anhänge wurden aufgrund von Validierungsfehlern entfernt. Bitte korrigieren Sie die Fehler und laden Sie die Dateien erneut hoch.
                </div>
                {{end}}

                {{if .AttachmentError}}
                <div class="attachment-error">{{.AttachmentError}}</div>
                {{end}}

                <!-- Existing Attachments -->
                {{if and .LinkedAttachments (gt (len .LinkedAttachments) 0)}}
                <details class="attachments-section border">
                    <summary class="attachments-label flex row gap align-center">
                        <i class="bi bi-images"></i>
                        Vorhandene Bilder ({{len .LinkedAttachments}})
                    </summary>

                    <div id="existing-attachments" class="flex column gap">
                        {{range .LinkedAttachments}}
                        <div class="attachment-item flex row gap justify-between align-center border" data-id="{{.GetID}}">
                            <div class="attachment-info flex row gap align-center">
                                <i class="bi bi-grip-vertical"></i>

                                <i class="bi bi-image attachment-icon"></i>

                                <span class="ellipsis">Bild {{.ID}}</span>

                                <span class="muted text-sm">({{.GetMimeType}})</span>
                            </div>

                            <div class="attachment-actions flex row gap">
                                <button
                                    type="button"
                                    class="secondary flex row gap align-center"
                                    onclick="window.dialogEditFunctions.viewAttachment({{$.ID}}, {{.GetID}}, '{{if .IsImage}}true{{else}}false{{end}}')"
                                >
                                    <small class="flex row gap align-center">
                                        <i class="bi bi-eye"></i>
                                        Anzeigen
                                    </small>
                                </button>

                                <button
                                    type="button"
                                    class="destructive flex row gap align-center"
                                    onclick="deleteAttachment({{.GetID}})"
                                >
                                    <small class="flex row gap align-center">
                                        <i class="bi bi-trash"></i>
                                        Löschen
                                    </small>
                                </button>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </details>
                {{end}}

                <!-- File Upload Area -->
                <div
                    class="file-input-area flex column gap align-center justify-center text-center"
                    onclick="document.getElementById('attachments').click()"
                    ondrop="window.dialogEditFunctions.handleFileDrop(event)"
                    ondragover="window.dialogEditFunctions.handleDragOver(event)"
                    ondragleave="window.dialogEditFunctions.handleDragLeave(event)"
                >
                    <i class="bi bi-cloud-upload" style="font-size: 2em;"></i>

                    <div class="text-center">Klicken Sie hier oder ziehen Sie Bilder hierher</div>

                    <div class="muted text-center text-sm">
                        Unterstützte Formate: JPG, PNG, GIF, BMP, SVG, WebP
                    </div>

                    <input
                        type="file"
                        name="attachments"
                        id="attachments"
                        multiple
                        accept="image/*"
                        onchange="window.dialogEditFunctions.handleFileSelect(event)"
                    />
                </div>

                <!-- File Preview Area -->
                <div id="file-preview" class="file-preview flex column gap border">
                    <div class="attachments-label">Neue Bilder:</div>

                    <div id="new-attachments" class="flex column gap"></div>

                    <template name="attachment-item">
                        <div class="attachment-item flex row gap justify-between align-center">
                            <div class="attachment-info flex row gap align-center">
                                <i class="bi bi-file-earmark attachment-icon"></i>
                                <span class="name ellipsis"></span>
                                <span class="size-text"></span>
                            </div>

                            <div class="attachment-actions flex row gap">
                                <button
                                    type="button"
                                    class="delete destructive flex row gap align-center"
                                >
                                    <small class="flex row gap align-center">
                                        <i class="bi bi-trash"></i>
                                        Entfernen
                                    </small>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <footer class="flex row gap justify-end">
            <button
                hx-get="./trouble-reports/dialog-edit?cancel=true"
                hx-trigger="click"
                hx-target="#dialogEdit"
                hx-swap="outerHTML"
                type="button"
                class="secondary flex gap"
            >
                <i class="bi bi-x-circle"></i>
                Schließen
            </button>

            <!-- Set button text based on ID value -->
            <button type="submit" class="flex row gap">
                <i class="bi bi-check-circle"></i>
                {{if gt .ID 0}} Aktualisieren {{else}} Erstellen {{end}}
            </button>
        </footer>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.querySelector("#dialogEdit").showModal();

        // TODO: Sortable stuff here for drag and drop
    </script>
</dialog>
{{else}}
<span
    hx-get="./trouble-reports/data"
    hx-trigger="load"
    hx-target="#data"
    hx-swap="outerHTML"
    id="dialogEdit"></span>
{{end}}
