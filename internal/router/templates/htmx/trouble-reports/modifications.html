<!-- TODO: Rename this file to something more descriptive -->

<div id="data" class="flex column gap">
    <div class="flex gap justify-between align-center wrap">
        <button
            hx-get="./trouble-reports/data"
            hx-trigger="click"
            hx-target="#data"
            hx-swap="outerHTML"
            class="ghost secondary flex gap"
        >
            <i class="bi bi-arrow-left"></i>Zurück
        </button>

        <h4>Änderungsverlauf</h4>


    </div>

    <div id="modifications-list" class="flex column gap">

        {{$user := .User}}
        {{$troubleReport := .TroubleReport}}
        {{$firstModified := .FirstModified}}
        {{$currentModified := $troubleReport.Mods.Current}}

        {{range $mod := .Mods}}

        <!-- Modification Container -->
        <article
            {{if eq $currentModified.Time $mod.Time}}
            style="
                border: 2px solid var(--ui-primary);
                border-radius: var(--ui-radius);
                padding-top: 2rem;
            "
            {{else}}
            style="
                border: 1px solid var(--ui-border-color);
                border-radius: var(--ui-radius);
            "
            {{end}}

            class="border"
        >
            {{if eq $currentModified.Time $mod.Time}}
            <!-- Mark the current modification -->
            <div
                style="
                    position: absolute;
                    top: -1px;
                    right: 12px;
                    padding: 4px 12px;
                    border-radius: 0 0 6px 6px;
                    font-size: 0.85em;
                "
                class="primary"
            >
                <b>Aktuelle Version</b>
            </div>
            {{end}}

            <div style="margin-bottom: var(--ui-spacing);">
                <div
                    style="
                        color: var(--ui-muted-text);
                        font-size: 0.9em;
                    "
                    class="flex gap align-center"
                >
                    {{if eq $firstModified.Time $mod.Time }}
                    <i class="bi bi-plus-circle" style="color: var(--ui-success);"></i>
                    <span>
                        Erstellt von <strong>{{$mod.User.UserName}}</strong> am {{$mod.GetTimeString}}
                    </span>
                    {{else}}
                    <i class="bi bi-pencil-square" style="color: var(--ui-warning);"></i>
                    <span>
                        Geändert von <strong>{{$mod.User.UserName}}</strong> am {{$mod.GetTimeString}}
                    </span>
                    {{end}}
                </div>
            </div>

            <div
                class="flex column gap"
                style="margin-bottom: var(--ui-spacing);"
            >
                <!-- Title and Content -->
                <h4>
                    {{$mod.Data.Title}}
                </h4>
                <pre
                    style="
                        padding: var(--ui-spacing);
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        overflow-y: auto;
                    "
                >{{$mod.Data.Content}}</pre>

                <!-- Attachments for this modification -->
                {{if and $mod.Data.LinkedAttachments (gt (len $mod.Data.LinkedAttachments) 0)}}
                <div
                    class="attachments-preview-placeholder"
                    data-modification-id="{{$troubleReport.ID}}-{{$mod.Time}}"
                    hx-get="./trouble-reports/modifications/attachments-preview/{{$troubleReport.ID}}?time={{$mod.Time}}"
                    hx-trigger="load-mod-attachments-{{$troubleReport.ID}}-{{$mod.Time}} from:body"
                    hx-swap="outerHTML"
                    style="
                        margin-top: var(--ui-spacing);
                        border: 1px solid var(--ui-border-color);
                        border-radius: var(--ui-radius);
                        padding: var(--ui-spacing);
                        transition: all 0.2s ease;
                    "
                >
                    <div class="attachments-preview-label" style="margin: 0;">
                        <i class="bi bi-paperclip"></i>
                        <span class="attachment-placeholder-text">
                            Anhänge ({{len $mod.Data.LinkedAttachments}}) - Klicken zum Laden
                        </span>
                        <i class="bi bi-mouse attachment-click-icon" style="opacity: 0.6; margin-left: 4px;"></i>
                    </div>
                </div>
                {{end}}
            </div>

            {{if ne $currentModified.Time $mod.Time}}
            <div
                style="
                    justify-content: flex-end;
                    padding-top: var(--ui-spacing);
                    border-top: 1px solid var(--ui-border-color);
                "
                class="flex gap"
            >
                {{if $user.IsAdmin}}
                <!-- Rollback Button -->
                <button
                    hx-post="./trouble-reports/modifications/{{$troubleReport.ID}}?time={{$mod.Time}}"
                    hx-trigger="click"
                    hx-target="#data"
                    hx-swap="outerHTML"
                    hx-confirm="Möchten Sie wirklich zu dieser Version zurückkehren?"
                    class="secondary flex gap"
                    style="font-size: 0.9em;"
                >
                    <i class="bi bi-arrow-counterclockwise"></i>
                    Zu dieser Version zurücksetzen
                </button>
                {{else}}
                <!-- Rollback Button (Vote) -->
                <button
                    hx-post="./trouble-reports/modifications/vote/{{$troubleReport.ID}}?time={{$mod.Time}}"
                    hx-trigger="click"
                    hx-target="#data"
                    hx-swap="outerHTML"
                    class="secondary flex gap"
                    style="font-size: 0.9em;"
                    disabled
                >
                    <i class="bi bi-arrow-counterclockwise"></i>
                    <small>ABSTIMMEN:</small> Zu dieser Version zurücksetzen
                </button>
                {{end}}
            </div>
            {{end}}
        </article>

        {{end}}
    </div>

    <script src="./js/trouble-reports/modifications.js" defer></script>
</div>
