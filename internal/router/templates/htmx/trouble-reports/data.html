{{$pageData := .}} {{if ne (len $pageData.TroubleReports) 0}}
<ul id="data">

    <script>
        async function shareTroubleReportPDF(troubleReportId, title) {
            var button = event.target.closest("button");
            if (!button) {
                alert("Fehler: Share-Button nicht gefunden.");
                return;
            }

            var originalContent = button.innerHTML;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            button.disabled = true;

            try {
                var response = await fetch(`./trouble-reports/share-pdf?id=${troubleReportId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                var blob = await response.blob();
                var filename = `fehlerbericht_${troubleReportId}_${new Date().toISOString().split("T")[0]}.pdf`;
                var isHTTPS = location.protocol === "https:";

                if (isHTTPS && navigator.share && navigator.canShare) {
                    var file = new File([blob], filename, { type: "application/pdf" });
                    var shareData = {
                        title: `Fehlerbericht: ${title}`,
                        text: `Fehlerbericht #${troubleReportId}`,
                        files: [file]
                    };

                    if (navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                            button.innerHTML = '<i class="bi bi-check-circle"></i>';
                            button.style.color = "green";
                            setTimeout(() => {
                                button.innerHTML = originalContent;
                                button.style.color = "blue";
                                button.disabled = false;
                            }, 1500);
                            return;
                        } catch (shareError) {}
                    }
                }

                var url = URL.createObjectURL(blob);
                var a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                button.innerHTML = '<i class="bi bi-download"></i>';
                button.style.color = "green";
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.color = "blue";
                    button.disabled = false;
                }, 1500);
            } catch (error) {
                console.error("Error sharing/downloading PDF:", error);
                alert("Fehler beim Erstellen oder Teilen der PDF. Bitte versuchen Sie es erneut.");
                button.innerHTML = originalContent;
                button.style.color = "blue";
                button.disabled = false;
            }
        }
    </script>

    {{range $troubleReport := $pageData.TroubleReports}}
    {{$id := print "trouble-report-" $troubleReport.ID}}
    <span class="trouble-report">
        <details
            id="{{$id}}"
        >
            <summary>{{$troubleReport.Title}}</summary>
            <pre>{{$troubleReport.Content}}</pre>

            <!-- Attachments Preview Container -->
            {{if and $troubleReport.LoadedAttachments (gt (len $troubleReport.LoadedAttachments) 0)}}
            <br />

            <div
                style="border-radius: var(--ui-radius);"
                class="attachments-preview-placeholder"
                data-trouble-report-id="{{$troubleReport.ID}}"
                hx-get="./trouble-reports/attachments-preview?id={{$troubleReport.ID}}"
                hx-trigger="load"
                hx-swap="outerHTML"
            >
                <div class="attachments-preview-label">
                    <i class="bi bi-paperclip"></i>
                    Anhänge ({{len $troubleReport.LoadedAttachments}}) - Klicken Sie hier, um zu laden...
                </div>
            </div>
            {{end}}

        </details>

        <div class="actions flex row gap justify-end align-center">
            <button
                hx-get="./trouble-reports/modifications/{{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                class="ghost secondary icon"
            >
                <i class="bi bi-clock-history"></i>
            </button>

            <button
                hx-get="./trouble-reports/dialog-edit?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#dialogEdit"
                hx-swap="outerHTML"
                class="ghost icon"
            >
                <i class="bi bi-pen"></i>
            </button>

            <button
                id="share-btn-{{$troubleReport.ID}}"
                onclick="shareTroubleReportPDF({{$troubleReport.ID}}, '{{$troubleReport.Title}}')"
                class="ghost icon info"
                title="Als PDF teilen"
            >
                <i class="bi bi-share"></i>
            </button>



            {{if $pageData.User.IsAdmin}}
            <button
                hx-delete="./trouble-reports/data?id={{$troubleReport.ID}}"
                hx-trigger="click"
                hx-target="#data"
                hx-swap="outerHTML"
                hx-confirm="Sind Sie sicher, dass Sie diesen Fehlerbericht löschen möchten?"
                class="ghost destructive icon"
            >
                <i class="bi bi-trash"></i>
            </button>

            {{else}}
            <!-- TODO: Benutzer ist kein Administrator, Abstimmungssystem zum Löschen von Problemberichten hinzufügen, noch nicht implementiert -->

            <button
                id="voteForDelete"
                hx-post="./trouble-reports/vote?id={{$troubleReport.ID}}&mode=delete"
                hx-trigger="click"
                hx-swap="outerHTML"
                class="ghost destructive flex column justify-between align-center"
                disabled
            >
                <i class="bi bi-trash"></i>
                <small>ABSTIMMEN</small>
            </button>
            {{end}}
        </div>
        <hr />
    </span>
    {{end}}
</ul>
{{else}}
<span id="data"></span>
{{end}}
