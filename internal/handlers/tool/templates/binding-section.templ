package templates

import (
	"github.com/knackwurstking/pg-press/internal/components"
	"github.com/knackwurstking/pg-press/internal/shared"
	"github.com/knackwurstking/pg-press/internal/urlb"
)

type BindingSectionProps struct {
	Tool                *shared.Tool
	CassettesForBinding []*shared.Cassette
	IsAdmin             bool
}

templ BindingSection(props BindingSectionProps) {
	<span id="binding-section" class="flex flex-col gap">
		@components.SectionTitle(components.SectionTitleLevelSub, "Werkzeuge Binden")
		<span
			class="flex gap flex-wrap"
			if !props.IsAdmin {
				disabled
			}
		>
			<select
				id="tool-binding-select"
				hx-patch={ urlb.UrlTool(props.Tool.ID, 0, 0, 0).Bind }
				hx-vals="js:{target_id: event.target.value}"
				hx-trigger="change"
				hx-target="#binding-section"
				hx-swap="outerHTML"
				if props.Tool.Cassette > 0 {
					disabled
				}
			>
				<option
					value=""
					disabled
					selected?={ props.Tool.Cassette <= 0 }
				>
					if props.Tool.Position == shared.SlotUpper {
						{ shared.SlotUpperCassette.German() }
					} else {
						{ shared.SlotUpper.German() }
					}
					Binden
				</option>
				for _, c := range props.CassettesForBinding {
					<option
						value={ c.ID }
						selected?={ c.ID == props.Tool.Cassette }
					>{ c.String() }</option>
				}
			</select>
			<button
				class="small ghost destructive"
				hx-patch={ urlb.UrlTool(props.Tool.ID, 0, 0, 0).UnBind }
				hx-trigger="click"
				hx-target="#binding-section"
				hx-swap="outerHTML"
				hx-on:htmx:response-error="alert(event.detail.xhr.responseText);"
				if props.Tool.Cassette > 0 {
					disabled
				}
			>
				Entbinden
			</button>
		</span>
		if props.Tool.Cassette > 0 {
			<span>
				// Display the binding tool
				{{
					var bindingTool *shared.Cassette
					for _, c := range props.CassettesForBinding {
						if c.ID == props.Tool.Cassette {
							bindingTool = c
							break
						}
					}
				}}
				if bindingTool != nil {
					@components.CassetteAnchor(
						components.CassetteAnchorProps{
							Cassette: bindingTool,
							Tool:     props.Tool,
						},
					)
				} else {
					<!-- Binding tool not available -->
					<span class="text-sm italic info ghost">
						<i>Binding tool not available</i>
					</span>
				}
			</span>
		}
	</span>
}
