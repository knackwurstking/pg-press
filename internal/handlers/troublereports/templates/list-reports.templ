package templates

import (
	"fmt"

	"github.com/knackwurstking/pg-press/internal/components/accordion"
	"github.com/knackwurstking/pg-press/internal/components/button"
	"github.com/knackwurstking/pg-press/internal/components/icon"
	"github.com/knackwurstking/pg-press/internal/components/markdown"
	"github.com/knackwurstking/pg-press/internal/shared"
	"github.com/knackwurstking/pg-press/internal/urlb"
)

templ ListReports(user *shared.User, troubleReports []*shared.TroubleReport) {
	for _, tr := range troubleReports {
		@accordion.Accordion(accordion.Props{
			Class: "w-full",
		}) {
			@reportListItem(tr, user)
			<br/>
		}
	}
}

templ reportListItem(tr *shared.TroubleReport, user *shared.User) {
	@accordion.Item(accordion.ItemProps{
		ID:    fmt.Sprintf("trouble-report-%d", tr.ID),
		Class: "trouble-report border rounded px-4",
		Attributes: templ.Attributes{
			"ontoggle": `updateURLHash(event)`,
		},
	}) {
		@accordion.Trigger() {
			<span class="flex justify-between items-center w-full">
				{ tr.Title }
			</span>
		}
		@accordion.Content(accordion.ContentProps{
			Class: "relative",
		}) {
			<div class="actions top-0 right-0 flex gap-2 justify-end items-center w-full">
				// Edit Report
				@button.Button(button.Props{
					Size: button.SizeIcon,
					Attributes: templ.Attributes{
						"title": "Fehlerbericht bearbeiten",
					},
					Href:     string(urlb.Editor("troublereport", tr.ID, urlb.TroubleReports())),
					Disabled: !user.IsAdmin(),
				}) {
					@icon.Pen()
				}
				// Share Report (PDF)
				@button.Button(button.Props{
					Variant: button.VariantSecondary,
					Size:    button.SizeIcon,
					Attributes: templ.Attributes{
						"onclick": fmt.Sprintf(
							`downloadTroubleReportPDF(event, %s, %s)`,
							urlb.TroubleReportsSharePDF(tr.ID),
							"trouble_report_"+fmt.Sprintf("%d", tr.ID)+".pdf",
						),
						"title": "Fehlerbericht als PDF herunterladen",
					},
				}) {
					@icon.Share()
				}
				// Admin only: Delete Report
				@button.Button(button.Props{
					Variant: button.VariantDestructive,
					Size:    button.SizeIcon,
					Attributes: templ.Attributes{
						"hx-delete":             string(urlb.TroubleReportsDelete(tr.ID)),
						"hx-trigger":            "click",
						"hx-target":             "#data",
						"hx-confirm":            "Sind Sie sicher, dass Sie diesen Fehlerbericht löschen möchten?",
						"hx-on::response-error": "alert(event.detail.xhr.responseText)",
						"title":                 "Fehlerbericht löschen",
					},
					Disabled: !user.IsAdmin(),
				}) {
					@icon.Trash()
				}
			</div>
			@markdown.Markdown(markdown.Props{
				UseMarkdown: tr.UseMarkdown,
				Content:     tr.Content,
			})
			// Attachments Preview Container
			if len(tr.LinkedAttachments) > 0 {
				@attachmentsPreview(tr.ID, tr.LinkedAttachments)
			}
		}
	}
}

templ attachmentsPreview(trID shared.EntityID, linkedAttachments []string) {
	<div
		class="attachments-preview border p-4 rounded-md bg-muted text-muted-foreground cursor-pointer"
		data-trouble-report-id={ fmt.Sprintf("%d", trID) }
		hx-get={ urlb.TroubleReportsAttachmentsPreview(trID) }
		hx-trigger="click"
		hx-swap="outerHTML"
		hx-on::response-error="alert(event.detail.xhr.responseText)"
	>
		<div class="attachments-preview-label font-bold flex items-center gap-2">
			@icon.Paperclip()
			Anhänge ({ len(linkedAttachments) }) - Klicken Sie hier, um zu laden...
		</div>
	</div>
}
